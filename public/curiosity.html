<!-- public/curiosity.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curiosity - RedView</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Responsive iframe helper (16:9) */
        .iframe-wrap {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.08);
            background: #0b0b0b;
        }
        .iframe-wrap iframe {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        .glass {
            background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
            backdrop-filter: blur(6px);
            border: 1px solid rgba(255,255,255,0.12);
        }
    </style>
</head>
<body class="mars-bg min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Navigation -->
        <nav class="mb-8">
            <a href="/" class="inline-flex items-center text-white hover:text-gray-300 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Home
            </a>
        </nav>
        
        <!-- Rover Header -->
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden mb-8">
            <div class="h-64 md:h-80 bg-cover bg-center relative" 
                 style="background-image: url('https://spaceflightnow.com/wp-content/uploads/2017/10/728907main_pia16085b-43.jpg');">
                <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                <div class="absolute bottom-6 left-6 text-white">
                    <h1 class="text-4xl md:text-5xl font-bold mb-2">Curiosity</h1>
                    <p class="text-xl text-gray-200">Mars Science Laboratory</p>
                </div>
            </div>
            
            <div class="p-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-gray-900">2012</div>
                        <div class="text-sm text-gray-600 uppercase tracking-wider">Landing Year</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-gray-900">4000+</div>
                        <div class="text-sm text-gray-600 uppercase tracking-wider">Mission Days</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-gray-900">28km</div>
                        <div class="text-sm text-gray-600 uppercase tracking-wider">Distance Traveled</div>
                    </div>
                </div>

                <!-- NASA 3D Model -->
                <section class="mb-8">
                    <div class="glass rounded-2xl p-5 md:p-6 mb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900 mb-2">Curiosity Rover 3D Model</h3>
                            <p class="text-gray-700">Explore an interactive 3D model of the Curiosity rover.</p>
                        </div>
                    </div>
                    <div class="iframe-wrap" style="padding-top: 50%;">
                        <canvas id="glb-viewer" style="position: absolute; inset: 0; width: 100%; height: 100%; border: 0; background: #0a0a0a;"></canvas>
                        <div id="glb-loading" style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: white; font-family: sans-serif; z-index: 10;">
                            <div style="text-align: center;">
                                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-white mb-2"></div>
                                <p>Loading 3D model...</p>
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-3 text-center">
                        Credit: NASA/JPL-Caltech • Use mouse to rotate, scroll to zoom, right-click to pan
                    </p>
                </section>

                <!-- Embedded ArcGIS Scene (ABOVE image search) -->
                <section class="mb-8">
                    <div class="glass rounded-2xl p-5 md:p-6 mb-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-900">Interactive Path Viewer</h3>
                                <p class="text-gray-700">Explore Curiosity's traverse in 3D on Mars terrain.</p>
                            </div>
                            <a href="arcgis-curiosity.html" class="hidden md:inline-flex items-center px-3 py-2 rounded-lg bg-gray-900 text-white hover:bg-gray-800 transition-colors">
                                Open Fullscreen
                                <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 3h7m0 0v7m0-7L10 14"></path>
                                </svg>
                            </a>
                        </div>
                    </div>
                    <div class="iframe-wrap">
                        <iframe
                            id="arcgis-iframe-curiosity"
                            src="arcgis-curiosity.html"
                            title="Curiosity Rover Path - ArcGIS 3D Scene"
                            loading="lazy"
                            allowfullscreen
                            referrerpolicy="no-referrer-when-downgrade">
                        </iframe>
                    </div>
                    <div class="text-center mt-4">
                        <button 
                            id="capture-btn-curiosity"
                            onclick="captureArcGISView('curiosity')"
                            class="inline-flex items-center px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Capture Image of View
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-3 text-center">
                        Data sources: NASA / JPL / USGS / Esri • Use mouse/touch to pan, tilt, and zoom
                    </p>
                </section>
                
                <!-- Image Gallery Section -->
                <div class="bg-gray-50 rounded-xl p-6 border-2 border-dashed border-gray-300">
                    <h3 class="text-2xl font-bold text-gray-900 mb-4">Images from Curiosity</h3>
                    <p class="text-gray-700 mb-6">
                        NASA's Curiosity rover has been exploring Gale Crater since 2012, analyzing soil and rock samples to determine Mars' past habitability and climate conditions.
                    </p>
                    
                    <!-- Filter Controls -->
                    <div class="bg-white rounded-lg p-4 mb-6 border border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label for="camera-select" class="block text-sm font-medium text-gray-700 mb-2">Camera</label>
                                <select id="camera-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-gray-800">
                                    <option value="">All Cameras</option>
                                    <option value="Hazard Avoidance (Haz) cam">Hazard Avoidance (Haz) cam</option>
                                    <option value="Mars Descent Imager (MARDI) Cam">Mars Descent Imager (MARDI) Cam</option>
                                    <option value="Mars Hand Lens Imager (MAHLI) cam">Mars Hand Lens Imager (MAHLI) cam</option>
                                    <option value="Mastcam">Mastcam</option>
                                    <option value="Navcam">Navcam</option>
                                    <option value="Remote Micro Imager (RMI) cam">Remote Micro Imager (RMI) cam</option>
                                </select>
                            </div>
                            <div>
                                <label for="sol-select" class="block text-sm font-medium text-gray-700 mb-2">Sol</label>
                                <select id="sol-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-gray-800">
                                    <option value="">All Sols</option>
                                    <option value="1">Sol 1</option>
                                    <option value="2">Sol 2</option>
                                </select>
                            </div>
                            <div>
                                <button onclick="requestImages()" class="w-full px-6 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium">
                                    Request Imagery
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Placeholder State -->
                    <div id="placeholder" class="text-center py-12">
                        <div class="text-gray-400 mb-2">
                            <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <p class="text-gray-600 text-lg font-medium">Request images using the menu above</p>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="loading" class="hidden text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                        <p class="mt-2 text-gray-600">Loading images...</p>
                    </div>
                    
                    <!-- Error State -->
                    <div id="error" class="hidden text-center py-8">
                        <div class="text-red-500 mb-2">
                            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <p class="text-red-600 font-semibold">Failed to load images</p>
                        <p class="text-gray-600 mt-1" id="error-message">Please try again later.</p>
                        <button onclick="requestImages()" class="mt-4 px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors">
                            Retry
                        </button>
                    </div>
                    
                    <!-- No Images State -->
                    <div id="no-images" class="hidden text-center py-12">
                        <div class="text-gray-400 mb-2">
                            <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <p class="text-gray-600 text-lg font-medium">There are no images based on the given parameters</p>
                    </div>
                    
                    <!-- Image Grid -->
                    <div id="image-grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Images will be dynamically inserted here -->
                    </div>
                </div>
                
                <div class="text-center mt-8">
                    <a href="/" class="inline-flex items-center px-6 py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Return to Home
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        
        (function() {
            const canvas = document.getElementById('glb-viewer');
            const loadingDiv = document.getElementById('glb-loading');
            
            if (!canvas) return;
            
            // Scene setup
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);
            
            // Camera
            const camera = new THREE.PerspectiveCamera(
                45,
                canvas.clientWidth / canvas.clientHeight,
                0.1,
                1000
            );
            camera.position.set(5, 5, 5);
            
            // Renderer
            const renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true,
                alpha: true
            });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight1.position.set(10, 10, 5);
            directionalLight1.castShadow = true;
            scene.add(directionalLight1);
            
            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
            directionalLight2.position.set(-10, 5, -5);
            scene.add(directionalLight2);
            
            // Controls
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 2;
            controls.maxDistance = 20;
            controls.enablePan = true;
            
            // Load GLB model
            const loader = new GLTFLoader();
            loader.load(
                'curiosity.glb',
                function(gltf) {
                    const model = gltf.scene;
                    
                    // Center and scale model
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scale = 3 / maxDim;
                    
                    model.scale.multiplyScalar(scale);
                    model.position.sub(center.multiplyScalar(scale));
                    
                    // Enable shadows and improve material rendering
                    model.traverse(function(child) {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                            // Ensure materials are properly lit
                            if (child.material) {
                                child.material.needsUpdate = true;
                            }
                        }
                    });
                    
                    scene.add(model);
                    
                    // Hide loading
                    if (loadingDiv) {
                        loadingDiv.style.display = 'none';
                    }
                    
                    // Adjust camera to view model
                    camera.lookAt(0, 0, 0);
                    controls.update();
                },
                function(progress) {
                    // Progress callback
                    if (progress.total > 0) {
                        const percent = (progress.loaded / progress.total * 100).toFixed(0);
                        if (loadingDiv) {
                            const p = loadingDiv.querySelector('p');
                            if (p) p.textContent = `Loading 3D model... ${percent}%`;
                        }
                    }
                },
                function(error) {
                    console.error('Error loading GLB:', error);
                    if (loadingDiv) {
                        loadingDiv.innerHTML = '<p style="color: #ef4444;">Error loading 3D model. Please refresh the page.</p>';
                    }
                }
            );
            
            // Animation loop
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
            
            // Handle resize
            function handleResize() {
                const width = canvas.clientWidth;
                const height = canvas.clientHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }
            
            window.addEventListener('resize', handleResize);
        })();
    </script>
    <!-- make script path absolute so it works on /curiosity/ too -->
    <script src="/js/apiService.js"></script>
    <script>
        const api = new MarsRoverAPI();

        // Capture ArcGIS view screenshot
        function captureArcGISView(rover) {
            const iframeId = `arcgis-iframe-${rover}`;
            const buttonId = `capture-btn-${rover}`;
            const iframe = document.getElementById(iframeId);
            const button = document.getElementById(buttonId);
            
            if (!iframe || !iframe.contentWindow) {
                alert('Iframe not ready. Please wait for the map to load.');
                return;
            }

            // Disable button during capture
            button.disabled = true;
            button.classList.add('opacity-50', 'cursor-not-allowed');
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>Capturing...';

            // Send message to iframe to capture screenshot
            iframe.contentWindow.postMessage({ type: 'CAPTURE_SCREENSHOT' }, '*');

            // Listen for response
            const messageHandler = (event) => {
                if (event.data && event.data.type === 'SCREENSHOT_RESULT') {
                    window.removeEventListener('message', messageHandler);
                    
                    // Download the image
                    downloadImage(event.data.dataUrl, `curiosity-path-view-${Date.now()}.png`);
                    
                    // Re-enable button
                    button.disabled = false;
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                    button.innerHTML = originalText;
                } else if (event.data && event.data.type === 'SCREENSHOT_ERROR') {
                    window.removeEventListener('message', messageHandler);
                    alert('Failed to capture screenshot: ' + event.data.error);
                    
                    // Re-enable button
                    button.disabled = false;
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                    button.innerHTML = originalText;
                }
            };

            window.addEventListener('message', messageHandler);

            // Timeout after 10 seconds
            setTimeout(() => {
                window.removeEventListener('message', messageHandler);
                button.disabled = false;
                button.classList.remove('opacity-50', 'cursor-not-allowed');
                button.innerHTML = originalText;
            }, 10000);
        }

        // Download image function
        function downloadImage(dataUrl, filename) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function requestImages() {
            const camera = document.getElementById('camera-select').value;
            const sol = document.getElementById('sol-select').value;
            const placeholder = document.getElementById('placeholder');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const imageGrid = document.getElementById('image-grid');
            const noImages = document.getElementById('no-images');
            
            // Hide all states
            placeholder.classList.add('hidden');
            loading.classList.remove('hidden');
            error.classList.add('hidden');
            imageGrid.classList.add('hidden');
            noImages.classList.add('hidden');
            
            try {
                let photos = [];
                
                // If both camera and sol are selected, use filtered endpoint
                if (camera && sol) {
                    const data = await api.getImagesByCameraAndSol('curiosity', camera, sol);
                    photos = data.photos || [];
                } else {
                    // Otherwise, get latest images
                    const data = await api.getLatestCuriosityImages();
                    photos = data.latest_photos || [];
                }
                
                loading.classList.add('hidden');
                
                if (photos.length > 0) {
                    displayImages(photos);
                } else {
                    noImages.classList.remove('hidden');
                }
            } catch (err) {
                showError(err.message);
            }
        }
        
        function displayImages(photos) {
            const imageGrid = document.getElementById('image-grid');
            imageGrid.innerHTML = '';
            photos.forEach(photo => imageGrid.appendChild(createImageCard(photo)));
            imageGrid.classList.remove('hidden');
        }
        
        function createImageCard(photo) {
            const title = (photo.camera && (photo.camera.full_name || photo.camera.name)) || 'Unknown camera';
            const when = photo.earth_date ? new Date(photo.earth_date).toLocaleDateString() : '—';
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300';
            card.innerHTML = `
                <div class="aspect-w-16 aspect-h-12">
                    <img 
                        src="${photo.img_src}" 
                        alt="Mars surface image from ${title}"
                        class="w-full h-48 object-cover hover:scale-105 transition-transform duration-300"
                        loading="lazy"
                        onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSBBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NjY2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBhdmFpbGFibGU8L3RleHQ+PC9zdmc+'"
                    >
                </div>
                <div class="p-3">
                    <h4 class="font-semibold text-gray-900 text-sm mb-1">${title}</h4>
                    <p class="text-xs text-gray-600">Sol ${photo.sol} • ${when}</p>
                </div>
            `;
            return card;
        }
        
        function showError(message) {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const errorMessage = document.getElementById('error-message');
            loading.classList.add('hidden');
            errorMessage.textContent = message;
            error.classList.remove('hidden');
        }
    </script>
</body>
</html>
