<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Mars Rover Path Visualizer | ArcGIS API for JavaScript 4.33</title>
    <style>
        html, body, #viewDiv {
            padding: 0; margin: 0; height: 100%; width: 100%; background: black;
        }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-family: sans-serif; z-index: 100; font-size: 18px;
        }
    </style>
    <link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/dark/main.css">
    <script src="https://js.arcgis.com/4.33/"></script>
</head>
<body>
    <div id="viewDiv">
        <div id="loading">Loading Mars rover path...</div>
    </div>
    <script>
        require([
            "esri/Map",
            "esri/views/SceneView",
            "esri/layers/ElevationLayer",
            "esri/layers/TileLayer",
            "esri/layers/GraphicsLayer",
            "esri/Graphic",
            "esri/widgets/LayerList",
            "esri/geometry/Extent"
        ], (Map, SceneView, ElevationLayer, TileLayer, GraphicsLayer, Graphic, LayerList, Extent) => {
            
            // Mars elevation (terrain)
            const marsElevation = new ElevationLayer({
                url: "https://astro.arcgis.com/arcgis/rest/services/OnMars/MDEM200M/ImageServer",
                copyright: "NASA, ESA, HRSC, Goddard Space Flight Center, USGS Astrogeology Science Center, Esri"
            });

            // Mars imagery (MDIM)
            const marsImagery = new TileLayer({
                url: "https://astro.arcgis.com/arcgis/rest/services/OnMars/MDIM/MapServer",
                title: "Imagery",
                copyright: "USGS Astrogeology Science Center, NASA, JPL, Esri"
            });

            // Shaded relief (optional, toggleable)
            const shadedReliefLayer = new TileLayer({
                url: "https://astro.arcgis.com/arcgis/rest/services/OnMars/MColorDEM/MapServer",
                title: "Shaded Relief",
                copyright: "USGS Astrogeology Science Center, NASA, JPL, ESA, DLR, Esri",
                visible: false
            });

            // Graphics layer for waypoints
            const waypointLayer = new GraphicsLayer({ 
                title: "Rover Waypoints",
                elevationInfo: { mode: "absolute-height" }
            });

            // Graphics layer for the path line
            const pathLineLayer = new GraphicsLayer({ 
                title: "Rover Path Line",
                elevationInfo: { mode: "absolute-height" }
            });

            const map = new Map({
                ground: { layers: [marsElevation] },
                layers: [marsImagery, shadedReliefLayer, pathLineLayer, waypointLayer]
            });

            const view = new SceneView({
                map: map,
                container: "viewDiv",
                qualityProfile: "high",
                spatialReference: { wkid: 104971 }, // Mars_2000
                viewingMode: "global"
            });

            // Add layer list widget
            const layerList = new LayerList({ view });
            view.ui.add(layerList, "top-right");

            // Hide loading when ready
            view.when(() => {
                document.getElementById('loading').style.display = 'none';
                loadRoverPath();
            });

            // Expose screenshot function to parent window
            window.captureScreenshot = function() {
                return new Promise((resolve, reject) => {
                    if (!view) {
                        reject(new Error('View not ready'));
                        return;
                    }
                    view.takeScreenshot({
                        width: view.width,
                        height: view.height,
                        format: "png"
                    }).then((screenshot) => {
                        resolve(screenshot.dataUrl);
                    }).catch((error) => {
                        reject(error);
                    });
                });
            };

            // Listen for postMessage requests from parent
            window.addEventListener('message', async (event) => {
                if (event.data && event.data.type === 'CAPTURE_SCREENSHOT') {
                    try {
                        const dataUrl = await window.captureScreenshot();
                        event.source.postMessage({
                            type: 'SCREENSHOT_RESULT',
                            dataUrl: dataUrl
                        }, event.origin);
                    } catch (error) {
                        event.source.postMessage({
                            type: 'SCREENSHOT_ERROR',
                            error: error.message
                        }, event.origin);
                    }
                }
            });

            // Add click handler for waypoints
            view.on("click", (event) => {
                view.hitTest(event).then((response) => {
                    if (response.results.length > 0) {
                        const graphic = response.results.find(r => r.graphic && r.graphic.attributes && r.graphic.attributes.sol);
                        if (graphic) {
                            console.log("Clicked waypoint:", graphic.graphic.attributes);
                            console.log("Sol:", graphic.graphic.attributes.sol);
                        }
                    }
                });
            });

            async function loadRoverPath() {
                try {
                    const response = await fetch('https://mars.nasa.gov/mmgis-maps/M20/Layers/json/M20_waypoints.json');
                    const data = await response.json();
                    const features = data.features;
                    
                    if (!features || features.length === 0) {
                        console.error('No features in JSON');
                        return;
                    }

                    const lineOffset = 200; // Raise line by 200m above terrain
                    const labelOffset = 50; // Labels 50m above the line
                    
                    let minLon = Infinity, maxLon = -Infinity;
                    let minLat = Infinity, maxLat = -Infinity;

                    const lineGeometry = { 
                        type: "polyline", 
                        paths: [[]], 
                        spatialReference: { wkid: 104971 },
                        hasZ: true
                    };

                    features.forEach((feature) => {
                        const lon = feature.geometry.coordinates[0];
                        const lat = feature.geometry.coordinates[1];
                        const height = feature.geometry.coordinates[2];
                        const sol = feature.properties.sol;

                        // Track bounds
                        minLon = Math.min(minLon, lon);
                        maxLon = Math.max(maxLon, lon);
                        minLat = Math.min(minLat, lat);
                        maxLat = Math.max(maxLat, lat);

                        // Create waypoint marker at same height as line
                        const waypointGraphic = new Graphic({
                            geometry: {
                                type: "point",
                                longitude: lon,
                                latitude: lat,
                                z: height + lineOffset,
                                spatialReference: { wkid: 104971 }
                            },
                            symbol: {
                                type: "point-3d",
                                symbolLayers: [{
                                    type: "object",
                                    resource: { primitive: "sphere" },
                                    material: { color: [255, 255, 255] },
                                    width: 20,
                                    height: 20,
                                    depth: 20
                                }]
                            },
                            attributes: { sol: sol },
                            popupTemplate: {
                                title: "Sol {sol}",
                                content: "Rover waypoint on Sol {sol}<br>Elevation: " + height.toFixed(1) + "m"
                            }
                        });

                        // Create label above the line
                        const labelGraphic = new Graphic({
                            geometry: {
                                type: "point",
                                longitude: lon,
                                latitude: lat,
                                z: height + lineOffset + labelOffset,
                                spatialReference: { wkid: 104971 }
                            },
                            symbol: {
                                type: "point-3d",
                                symbolLayers: [{
                                    type: "text",
                                    text: "Sol " + sol,
                                    material: { color: [255, 255, 255] },
                                    halo: { size: 1.5, color: [0, 0, 0, 0.8] },
                                    font: { size: 10, weight: "bold" }
                                }],
                                verticalOffset: {
                                    screenLength: 0,
                                    maxWorldLength: 200000,
                                    minWorldLength: 0
                                },
                                callout: {
                                    type: "line",
                                    size: 0.5,
                                    color: [255, 255, 255, 0.9],
                                    border: { color: [0, 0, 0, 0.3] }
                                }
                            }
                        });

                        waypointLayer.add(waypointGraphic);
                        waypointLayer.add(labelGraphic);
                        
                        lineGeometry.paths[0].push([lon, lat, height + lineOffset]);
                    });

                    // Create the path line
                    const lineGraphic = new Graphic({
                        geometry: lineGeometry,
                        symbol: {
                            type: "line-3d",
                            symbolLayers: [{
                                type: "path",
                                profile: "circle",
                                material: { color: [0, 0, 255] },
                                width: 10,
                                cap: "round",
                                join: "round"
                            }]
                        }
                    });
                    pathLineLayer.add(lineGraphic);

                    // Calculate center and extent
                    const centerLon = (minLon + maxLon) / 2;
                    const centerLat = (minLat + maxLat) / 2;
                    
                    const extent = new Extent({
                        xmin: minLon,
                        ymin: minLat,
                        xmax: maxLon,
                        ymax: maxLat,
                        spatialReference: { wkid: 104971 }
                    });

                    // Zoom to the actual path extent
                    view.goTo({
                        target: extent.expand(1.5),
                        tilt: 65,
                        heading: 30
                    }, { duration: 3000 });

                } catch (error) {
                    console.error('Error loading path:', error);
                    document.getElementById('loading').textContent = 'Error loading rover data. Please check console.';
                }
            }
        });
    </script>
</body>
</html>